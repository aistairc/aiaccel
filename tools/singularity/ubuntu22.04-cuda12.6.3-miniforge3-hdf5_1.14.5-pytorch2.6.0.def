Bootstrap: docker
From: nvidia/cuda:12.6.3-cudnn-devel-ubuntu22.04

%environment
    LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    PATH="/opt/miniforge3/bin:$PATH"
    
    export LD_LIBRARY_PATH PATH

%post
    LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
    PATH=/opt/miniforge3/bin:/usr/local/bin:$PATH
    DEBIAN_FRONTEND=noninteractive

    export LD_LIBRARY_PATH PATH DEBIAN_FRONTEND

    apt update
    apt dist-upgrade -y

    # install apt packages
    apt install -y ca-certificates wget apt-utils
    update-ca-certificates

    apt install -y language-pack-ja
    apt install -y vim emacs-nox
    apt install -y htop bzip2 unzip byobu direnv bat colordiff
    apt install -y wget curl git mercurial subversion cmake pre-commit
    apt install -y sox flac ffmpeg
    apt install -y libglib2.0-0 libxext6 libsm6 libxrender1 libsndfile1-dev libxshmfence1 libglu1 libxdamage1 zlib1g-dev

    # install conda packages
    wget https://github.com/conda-forge/miniforge/releases/download/24.11.3-0/Miniforge3-Linux-x86_64.sh
    /bin/bash Miniforge3-Linux-x86_64.sh -b -p /opt/miniforge3
    rm Miniforge3-Linux-x86_64.sh

    conda config --prepend channels https://software.repos.intel.com/python/conda/

    mamba install -y -q \
        mkl==2025.0.1 cython==3.0.11 \
        ruff==0.9.3 mypy==1.14.1 \
        progressbar2==4.5.0 rich==13.9.4 tqdm==4.66.2 \
        numpy==1.26.4 scipy==1.15.1 scikit-learn==1.6.1 jupyter==1.1.1 pandas==2.2.3 matplotlib==3.10.0 \

    pip3 install torch==2.6.0 torchvision==0.21.0 torchaudio==2.6.0 --index-url https://download.pytorch.org/whl/cu126
    pip install tensorboard==2.18.0 protobuf==5.28.3
    pip install torchmetrics==1.6.1 lightning==2.5.0.post0
    pip install einops==0.8.0 opt_einsum==3.4.0

    pip install cupy-cuda12x==13.3.0
    pip install optuna==4.2.0

    # pip install hydra-core==1.3.2 omegaconf==2.3.0
    apt install -y default-jre
    pip install git+https://github.com/facebookresearch/hydra.git@7c8fa4a7594fe0c333ce6180adecd50f6d1f43b9
    pip install git+https://github.com/omry/omegaconf.git@117f7de07285e4d1324b9229eaf873de15279457

    pip install librosa==0.10.2.post1 soundfile==0.13.1

    pip install pesq==0.0.4 pystoi==0.4.1
    pip install mir_eval==0.7
    pip install auraloss==0.4.0

    # setup openmpi and mpi4py
    OMPI_VERSION=4.1.7
    wget https://download.open-mpi.org/release/open-mpi/v$(echo $OMPI_VERSION | cut -d. -f -2)/openmpi-${OMPI_VERSION}.tar.gz
    tar xf openmpi-${OMPI_VERSION}.tar.gz
    cd openmpi-${OMPI_VERSION}
    ./configure
    make -j
    make install
    cd ../
    rm -r openmpi-${OMPI_VERSION}
    rm openmpi-${OMPI_VERSION}.tar.gz

    # https://bitbucket.org/mpi4py/mpi4py/issues/143/build-failure-with-python-installed-from
    mv /opt/miniforge3/compiler_compat/ld /opt/miniforge3/compiler_compat/ld.bak
    pip install mpi4py==4.0.1
    mv /opt/miniforge3/compiler_compat/ld.bak /opt/miniforge3/compiler_compat/ld

    # h5py
    # https://bitbucket.org/mpi4py/mpi4py/issues/143/build-failure-with-python-installed-from
    mv /opt/miniforge3/compiler_compat/ld /opt/miniforge3/compiler_compat/ld.bak

    HDF_VERSION=1.14.5
    wget https://github.com/HDFGroup/hdf5/releases/download/hdf5_${HDF_VERSION}/hdf5-${HDF_VERSION}.tar.gz
    tar xf hdf5-${HDF_VERSION}.tar.gz
    cd hdf5-${HDF_VERSION}
    ./configure --prefix=/usr/local --with-zlib=/usr/include,/usr/lib/x86_64-linux-gnu --enable-parallel --enable-shared
    make -j
    make install
    make check-install
    cd ../
    rm -r hdf5-${HDF_VERSION}
    rm hdf5-${HDF_VERSION}.tar.gz

    git clone https://github.com/h5py/h5py.git
    cd h5py
    git checkout 3.12.1

    CC=mpicc HDF5_MPI=ON pip install .
    cd ../
    rm -r h5py

    mv /opt/miniforge3/compiler_compat/ld.bak /opt/miniforge3/compiler_compat/ld
    
    apt clean

%runscript
    if [ -z "$1" ]; then
        byobu
    else
        $@
    fi
